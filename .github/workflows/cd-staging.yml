# =============================================================================
# BOSSNYUMBA CD - Staging Environment
# =============================================================================
# Triggers: Push to develop branch, manual dispatch
# Deploys: All services to staging environment
# =============================================================================

name: CD Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to deploy (comma-separated, or "all")'
        required: false
        default: 'all'

concurrency:
  group: cd-staging
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'
  AWS_REGION: eu-west-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.eu-west-1.amazonaws.com
  ENVIRONMENT: staging

jobs:
  # ============================================
  # Determine what changed
  # ============================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api-gateway: ${{ steps.filter.outputs.api-gateway }}
      customer-app: ${{ steps.filter.outputs.customer-app }}
      estate-manager: ${{ steps.filter.outputs.estate-manager }}
      owner-portal: ${{ steps.filter.outputs.owner-portal }}
      admin-portal: ${{ steps.filter.outputs.admin-portal }}
      payments: ${{ steps.filter.outputs.payments }}
      notifications: ${{ steps.filter.outputs.notifications }}
      reports: ${{ steps.filter.outputs.reports }}
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api-gateway:
              - 'services/api-gateway/**'
              - 'packages/**'
              - 'docker/Dockerfile.api'
            customer-app:
              - 'apps/customer-app/**'
              - 'packages/**'
            estate-manager:
              - 'apps/estate-manager-app/**'
              - 'packages/**'
            owner-portal:
              - 'apps/owner-portal/**'
              - 'packages/**'
            admin-portal:
              - 'apps/admin-portal/**'
              - 'packages/**'
            payments:
              - 'services/payments/**'
              - 'packages/**'
            notifications:
              - 'services/notifications/**'
              - 'packages/**'
            reports:
              - 'services/reports/**'
              - 'packages/**'
            infrastructure:
              - 'infrastructure/**'

  # ============================================
  # Build and Push Docker Images
  # ============================================
  build-api:
    name: Build API Gateway
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.api-gateway == 'true' || github.event.inputs.services == 'all'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push API Gateway
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.api
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/bossnyumba/api-gateway:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/bossnyumba/api-gateway:staging
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-apps:
    name: Build ${{ matrix.app }}
    runs-on: ubuntu-latest
    needs: changes
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: customer-app
            path: apps/customer-app
            target: nextjs
          - app: estate-manager-app
            path: apps/estate-manager-app
            target: nextjs
          - app: owner-portal
            path: apps/owner-portal
            target: vite
          - app: admin-portal
            path: apps/admin-portal
            target: vite
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push ${{ matrix.app }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.web
          target: ${{ matrix.target }}
          push: true
          build-args: |
            APP_NAME=${{ matrix.app }}
            APP_PATH=${{ matrix.path }}
          tags: |
            ${{ env.ECR_REGISTRY }}/bossnyumba/${{ matrix.app }}:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/bossnyumba/${{ matrix.app }}:staging
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Deploy Infrastructure (Terraform)
  # ============================================
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.infrastructure == 'true'
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/staging
        run: terraform init -backend-config=backend.hcl
        continue-on-error: true

      - name: Terraform Plan
        working-directory: infrastructure/terraform/environments/staging
        run: terraform plan -var-file=staging.tfvars -out=tfplan
        continue-on-error: true

      - name: Terraform Apply
        working-directory: infrastructure/terraform/environments/staging
        run: terraform apply -auto-approve tfplan
        continue-on-error: true

  # ============================================
  # Deploy to ECS
  # ============================================
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-api, build-apps]
    if: always() && !cancelled()
    environment: staging
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update ECS services
        run: |
          aws ecs update-service \
            --cluster bossnyumba-staging-cluster \
            --service bossnyumba-staging-api \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }} || echo "Service update failed or not configured"

  # ============================================
  # Smoke Tests
  # ============================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Health check
        run: |
          if [ -n "${{ vars.STAGING_API_URL }}" ]; then
            curl -sf "${{ vars.STAGING_API_URL }}/health" --retry 5 --retry-delay 10 || echo "Health check skipped"
          fi

  # ============================================
  # Summary
  # ============================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy, smoke-tests]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
