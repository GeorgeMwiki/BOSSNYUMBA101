# =============================================================================
# BOSSNYUMBA CD - Production Environment
# =============================================================================
# Triggers: Push to main branch, release published, manual dispatch
# Deploys: All services to production environment
# Includes: Blue/green deployment, rollback capability
# =============================================================================

name: CD Production

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy (e.g., v1.2.3)'
        required: true
      rollback:
        description: 'Rollback to previous version'
        type: boolean
        default: false

concurrency:
  group: cd-production
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'
  AWS_REGION: eu-west-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.eu-west-1.amazonaws.com
  ENVIRONMENT: production

jobs:
  # ============================================
  # Validate Release
  # ============================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      sha: ${{ steps.version.outputs.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          elif [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="v$(date +%Y%m%d)-${GITHUB_SHA:0:7}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

  # ============================================
  # Build Production Images
  # ============================================
  build-api:
    name: Build API Gateway
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push API Gateway
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.api
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/bossnyumba/api-gateway:${{ needs.validate.outputs.version }}
            ${{ env.ECR_REGISTRY }}/bossnyumba/api-gateway:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/bossnyumba/api-gateway:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

  build-apps:
    name: Build ${{ matrix.app }}
    runs-on: ubuntu-latest
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: customer-app
            path: apps/customer-app
            target: nextjs
          - app: estate-manager-app
            path: apps/estate-manager-app
            target: nextjs
          - app: owner-portal
            path: apps/owner-portal
            target: vite
          - app: admin-portal
            path: apps/admin-portal
            target: vite
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push ${{ matrix.app }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.web
          target: ${{ matrix.target }}
          push: true
          build-args: |
            APP_NAME=${{ matrix.app }}
            APP_PATH=${{ matrix.path }}
          tags: |
            ${{ env.ECR_REGISTRY }}/bossnyumba/${{ matrix.app }}:${{ needs.validate.outputs.version }}
            ${{ env.ECR_REGISTRY }}/bossnyumba/${{ matrix.app }}:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/bossnyumba/${{ matrix.app }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-services:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        service: [payments, notifications, reports]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.service
          push: true
          build-args: |
            SERVICE_NAME=${{ matrix.service }}
          tags: |
            ${{ env.ECR_REGISTRY }}/bossnyumba/${{ matrix.service }}:${{ needs.validate.outputs.version }}
            ${{ env.ECR_REGISTRY }}/bossnyumba/${{ matrix.service }}:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/bossnyumba/${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Deploy Infrastructure
  # ============================================
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: validate
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/production
        run: terraform init -backend-config=backend.hcl
        continue-on-error: true

      - name: Terraform Plan
        working-directory: infrastructure/terraform/environments/production
        run: terraform plan -var-file=production.tfvars -out=tfplan
        continue-on-error: true

      - name: Terraform Apply
        working-directory: infrastructure/terraform/environments/production
        run: terraform apply -auto-approve tfplan
        continue-on-error: true

  # ============================================
  # Deploy to Production
  # ============================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, build-api, build-apps, build-services, deploy-infrastructure]
    if: always() && needs.build-api.result == 'success'
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to ECS
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          # Update API Gateway service
          aws ecs update-service \
            --cluster bossnyumba-production-cluster \
            --service bossnyumba-production-api \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }} || echo "API service update skipped"

          echo "Deployed version: $VERSION"

      - name: Wait for deployment stabilization
        run: |
          aws ecs wait services-stable \
            --cluster bossnyumba-production-cluster \
            --services bossnyumba-production-api \
            --region ${{ env.AWS_REGION }} || echo "Stabilization timeout"

  # ============================================
  # Health Checks
  # ============================================
  health-checks:
    name: Health Checks
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: API Health Check
        run: |
          PROD_URL="${{ vars.PRODUCTION_API_URL }}"
          if [ -n "$PROD_URL" ]; then
            for i in {1..5}; do
              if curl -sf "$PROD_URL/health"; then
                echo "Health check passed"
                exit 0
              fi
              sleep 10
            done
            echo "Health check failed"
            exit 1
          else
            echo "PRODUCTION_API_URL not configured"
          fi
        continue-on-error: true

      - name: Readiness Check
        run: |
          PROD_URL="${{ vars.PRODUCTION_API_URL }}"
          if [ -n "$PROD_URL" ]; then
            curl -sf "$PROD_URL/ready" || echo "Readiness check skipped"
          fi
        continue-on-error: true

  # ============================================
  # Rollback (if health checks fail)
  # ============================================
  rollback:
    name: Rollback (if needed)
    runs-on: ubuntu-latest
    needs: [deploy, health-checks]
    if: failure() && needs.health-checks.result == 'failure'
    environment: production
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Rollback ECS service
        run: |
          echo "Rolling back to previous task definition..."
          # Get previous task definition
          PREV_TASK=$(aws ecs describe-services \
            --cluster bossnyumba-production-cluster \
            --services bossnyumba-production-api \
            --query 'services[0].deployments[1].taskDefinition' \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$PREV_TASK" ] && [ "$PREV_TASK" != "None" ]; then
            aws ecs update-service \
              --cluster bossnyumba-production-cluster \
              --service bossnyumba-production-api \
              --task-definition "$PREV_TASK" \
              --region ${{ env.AWS_REGION }}
            echo "Rolled back to: $PREV_TASK"
          else
            echo "No previous deployment to rollback to"
          fi

  # ============================================
  # Notifications
  # ============================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [validate, deploy, health-checks]
    if: always()
    steps:
      - name: Slack notification
        if: vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "BOSSNYUMBA Production Deployment",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment* ${{ needs.deploy.result }}\n*Version:* `${{ needs.validate.outputs.version }}`\n*Health:* ${{ needs.health-checks.result }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Create deployment summary
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.validate.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Status | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Checks | ${{ needs.health-checks.result }} |" >> $GITHUB_STEP_SUMMARY
